name: Build SAA with Dynamic Config

on:
  push:
    tags:
      - 'v*'
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_mode:
        description: 'Build mode'
        type: choice
        options:
        - nuitka
        - pyinstaller
        default: nuitka
      create_release:
        description: 'Create release'
        type: boolean
        default: false

jobs:
  get-config:
    runs-on: ubuntu-latest
    outputs:
      app_ver: ${{ steps.config.outputs.app_ver }}
      app_name: ${{ steps.config.outputs.app_name }}
      app_exec: ${{ steps.config.outputs.app_exec }}
      app_publisher: ${{ steps.config.outputs.app_publisher }}
      app_url: ${{ steps.config.outputs.app_url }}
      app_icon: ${{ steps.config.outputs.app_icon }}
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Extract config from perfect_build.py
      id: config
      run: |
        python3 << 'EOF'
        import sys
        import os
        sys.path.append('PerfectBuild')
        
        try:
            from perfect_build import Config
            
            # è¾“å‡ºé…ç½®åˆ° GitHub Actions çŽ¯å¢ƒå˜é‡
            print(f"app_ver={Config.app_ver}")
            print(f"app_name={Config.app_name}")
            print(f"app_exec={Config.app_exec}")
            print(f"app_publisher={Config.app_publisher}")
            print(f"app_url={Config.app_url}")
            print(f"app_icon={Config.app_icon}")
            
            # è®¾ç½®ä¸º GitHub Actions è¾“å‡º
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                f.write(f"app_ver={Config.app_ver}\n")
                f.write(f"app_name={Config.app_name}\n")
                f.write(f"app_exec={Config.app_exec}\n")
                f.write(f"app_publisher={Config.app_publisher}\n")
                f.write(f"app_url={Config.app_url}\n")
                f.write(f"app_icon={Config.app_icon}\n")
                
        except ImportError as e:
            print(f"Error importing config: {e}")
            # ä½¿ç”¨é»˜è®¤å€¼
            defaults = {
                'app_ver': '2.0.5-official',
                'app_name': 'SAA',
                'app_exec': 'SAA',
                'app_publisher': 'laozhu',
                'app_url': 'https://github.com/LaoZhuJackson/SnowbreakAutoAssistant',
                'app_icon': 'app/resource/images/logo.ico'
            }
            
            with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
                for key, value in defaults.items():
                    f.write(f"{key}={value}\n")
        EOF

  build:
    needs: get-config
    strategy:
      matrix:
        os: [windows-latest]
        python-version: ['3.10']
      fail-fast: false

    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        architecture: 'x64'
        cache: 'pip'
        cache-dependency-path: requirements.txt

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Build with Nuitka (from config)
      if: github.event.inputs.build_mode != 'pyinstaller'
      uses: Nuitka/Nuitka-Action@main
      with:
        nuitka-version: main
        script-name: ${{ needs.get-config.outputs.app_exec }}.py
        mode: standalone
        enable-plugins: pyqt5
        windows-uac-admin: true
        windows-console-mode: disable
        windows-icon-from-ico: ${{ needs.get-config.outputs.app_icon }}
        output-dir: build
        output-file: ${{ needs.get-config.outputs.app_exec }}.exe
        
        # åŒ…å«æ•°æ®æ–‡ä»¶å’Œç›®å½•ï¼ˆåŸºäºŽ build.py ä¸­çš„é…ç½®ï¼‰
        include-data-files: |
          patch/scipy.libs/.load-order-scipy-1.10.1=scipy.libs/.load-order-scipy-1.10.1
          patch/shapely.libs/.load-order-shapely-2.0.7=shapely.libs/.load-order-shapely-2.0.7
          AppData/ocr_replacements.json=AppData/ocr_replacements.json
          docs/help.md=docs/help.md
          update_data.txt=update_data.txt
        
        include-data-dir: |
          app/resource/images=app/resource/images
          asset=asset
          app/modules/onnxocr/models=app/modules/onnxocr/models
        
        include-package: |
          app
          PyQt5
          qfluentwidgets
        
        # æŽ’é™¤ä¸éœ€è¦çš„æ¨¡å—
        nofollow-import-to: |
          *.tests
          test
          tests
          unittest
          doctest
          setuptools
          distutils

    - name: Build with PyInstaller (fallback)
      if: github.event.inputs.build_mode == 'pyinstaller'
      run: |
        pyinstaller --onedir --add-data="app/resource/images;app/resource/images" --add-data="asset;asset" --add-data="AppData/ocr_replacements.json;AppData" --add-data="docs/help.md;docs" --add-data="update_data.txt;." --add-data="app/modules/onnxocr/models;app/modules/onnxocr/models" -i "${{ needs.get-config.outputs.app_icon }}" --name "${{ needs.get-config.outputs.app_exec }}" --distpath build/dist --workpath build/build --contents-directory=. "${{ needs.get-config.outputs.app_exec }}.py"
      shell: bash

    - name: Verify build
      run: |
        if (Test-Path "build/${{ needs.get-config.outputs.app_exec }}.dist/${{ needs.get-config.outputs.app_exec }}.exe") {
          Write-Host "Nuitka build successful! ${{ needs.get-config.outputs.app_exec }}.exe created."
          Get-ChildItem "build/${{ needs.get-config.outputs.app_exec }}.dist" -Recurse | Select-Object Name, Length | Format-Table
        } elseif (Test-Path "build/dist/${{ needs.get-config.outputs.app_exec }}/${{ needs.get-config.outputs.app_exec }}.exe") {
          Write-Host "PyInstaller build successful! ${{ needs.get-config.outputs.app_exec }}.exe created."
          Get-ChildItem "build/dist/${{ needs.get-config.outputs.app_exec }}" -Recurse | Select-Object Name, Length | Format-Table
        } else {
          Write-Error "Build failed! ${{ needs.get-config.outputs.app_exec }}.exe not found."
          Get-ChildItem build -Recurse | Format-Table
          exit 1
        }
      shell: powershell

    - name: Cache Inno Setup installer
      if: github.event.inputs.build_mode != 'pyinstaller'
      uses: actions/cache@v4
      id: cache-inno-installer
      with:
        path: ${{ runner.temp }}\innosetup-6.2.2.exe
        key: innosetup-6.2.2-installer

    - name: Download Inno Setup installer
      if: github.event.inputs.build_mode != 'pyinstaller' && steps.cache-inno-installer.outputs.cache-hit != 'true'
      run: |
        $url = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
        $output = "$env:TEMP\innosetup-6.2.2.exe"
        Write-Host "Downloading Inno Setup from: $url"
        Invoke-WebRequest -Uri $url -OutFile $output
        Write-Host "Downloaded to: $output"
      shell: powershell

    - name: Cache Inno Setup installation
      if: github.event.inputs.build_mode != 'pyinstaller'
      uses: actions/cache@v4
      id: cache-inno-setup
      with:
        path: C:\Program Files (x86)\Inno Setup 6
        key: innosetup-6.2.2-installation-${{ runner.os }}

    - name: Install Inno Setup
      if: github.event.inputs.build_mode != 'pyinstaller' && steps.cache-inno-setup.outputs.cache-hit != 'true'
      run: |
        $installer = "$env:TEMP\innosetup-6.2.2.exe"
        if (Test-Path $installer) {
          Write-Host "Installing Inno Setup from cached installer..."
          Start-Process -FilePath $installer -ArgumentList "/VERYSILENT", "/SUPPRESSMSGBOXES", "/NORESTART" -Wait
          Write-Host "Inno Setup installation completed"
        } else {
          Write-Error "Installer not found at: $installer"
          exit 1
        }
      shell: powershell

    - name: Add Inno Setup to PATH
      if: github.event.inputs.build_mode != 'pyinstaller'
      run: |
        $innoPath = "C:\Program Files (x86)\Inno Setup 6"
        if (Test-Path $innoPath) {
          echo $innoPath | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          Write-Host "Added Inno Setup to PATH: $innoPath"
          
          # éªŒè¯å®‰è£…
          $compiler = "$innoPath\Compil32.exe"
          if (Test-Path $compiler) {
            Write-Host "âœ“ Inno Setup compiler found: $compiler"
          } else {
            Write-Warning "âš  Inno Setup compiler not found at expected location"
          }
        } else {
          Write-Warning "âš  Inno Setup installation directory not found"
        }
      shell: powershell

    - name: Create installer and portable packages
      run: |
        $version = "${{ needs.get-config.outputs.app_ver }}"
        $appName = "${{ needs.get-config.outputs.app_exec }}"
        $buildMode = "${{ github.event.inputs.build_mode }}"
        if (-not $buildMode) { $buildMode = "nuitka" }
        
        # åˆ›å»ºä¾¿æºç‰ˆ
        $portableArchiveName = "${appName}-${version}-${buildMode}-Portable-Windows-x64.zip"
        
        if (Test-Path "build/${appName}.dist") {
          # Nuitka æž„å»º
          Write-Host "Creating portable package from Nuitka build..."
          Compress-Archive -Path "build/${appName}.dist/*" -DestinationPath $portableArchiveName -CompressionLevel Optimal
          
          # ä¸º Nuitka æž„å»ºåˆ›å»ºå®‰è£…ç¨‹åº
          if ($buildMode -ne "pyinstaller") {
            Write-Host "Creating installer for Nuitka build..."
            
            # åˆ›å»º ISS è„šæœ¬æ–‡ä»¶
            $issFile = "${appName}-setup.iss"
            
            # å†™å…¥ ISS è„šæœ¬å†…å®¹
            $issLines = @(
              '#define MyAppName "${{ needs.get-config.outputs.app_name }}"',
              '#define MyAppVersion "${{ needs.get-config.outputs.app_ver }}"',
              '#define MyAppPublisher "${{ needs.get-config.outputs.app_publisher }}"',
              '#define MyAppURL "${{ needs.get-config.outputs.app_url }}"',
              '#define MyAppExeName "${{ needs.get-config.outputs.app_exec }}.exe"',
              '',
              '[Setup]',
              'AppId={{EF37701A-BF20-4C1C-8459-34041F620CFE}',
              'AppName={#MyAppName}',
              'AppVersion={#MyAppVersion}',
              'AppPublisher={#MyAppPublisher}',
              'AppPublisherURL={#MyAppURL}',
              'AppSupportURL={#MyAppURL}',
              'AppUpdatesURL={#MyAppURL}',
              'DefaultDirName={autopf}\{#MyAppName}',
              'DisableProgramGroupPage=yes',
              'OutputDir=.',
              'OutputBaseFilename=${{ needs.get-config.outputs.app_exec }}-${{ needs.get-config.outputs.app_ver }}-Setup-Windows-x64',
              'SetupIconFile=${{ needs.get-config.outputs.app_icon }}',
              'Compression=lzma',
              'SolidCompression=yes',
              'WizardStyle=modern',
              'PrivilegesRequired=admin',
              '',
              '[Languages]',
              'Name: "english"; MessagesFile: "compiler:Default.isl"',
              'Name: "chinesesimp"; MessagesFile: "compiler:Languages\ChineseSimplified.isl"',
              '',
              '[Tasks]',
              'Name: "desktopicon"; Description: "{cm:CreateDesktopIcon}"; GroupDescription: "{cm:AdditionalIcons}"; Flags: unchecked',
              '',
              '[Files]',
              'Source: "build\${{ needs.get-config.outputs.app_exec }}.dist\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs createallsubdirs',
              '',
              '[Icons]',
              'Name: "{autoprograms}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"',
              'Name: "{autodesktop}\{#MyAppName}"; Filename: "{app}\{#MyAppExeName}"; Tasks: desktopicon',
              '',
              '[Run]',
              'Filename: "{app}\{#MyAppExeName}"; Description: "{cm:LaunchProgram,{#StringChange(MyAppName, ''&'', ''&&'')}}"; Flags: nowait postinstall skipifsilent'
            )
            
            $issLines | Set-Content $issFile -Encoding UTF8
            Write-Host "Created ISS script: $issFile"
            
            # è¿è¡Œ Inno Setup ç¼–è¯‘å™¨
            $innoCompiler = "C:\Program Files (x86)\Inno Setup 6\Compil32.exe"
            
            if (Test-Path $innoCompiler -and (Test-Path $issFile)) {
              Write-Host "Running Inno Setup compiler..."
              Write-Host "Compiler: $innoCompiler"
              Write-Host "Script: $issFile"
              
              # è¿è¡Œç¼–è¯‘å™¨å¹¶ç­‰å¾…å®Œæˆ
              $process = Start-Process -FilePath $innoCompiler -ArgumentList "/cc", $issFile -Wait -PassThru -WindowStyle Hidden
              
              $installerName = "${appName}-${version}-Setup-Windows-x64.exe"
              if ($process.ExitCode -eq 0 -and (Test-Path $installerName)) {
                Write-Host "âœ“ Successfully created installer: $installerName"
              } else {
                Write-Warning "âš  Installer creation failed (exit code: $($process.ExitCode))"
                Write-Host "Checking for any generated files..."
                Get-ChildItem -Filter "*.exe" | Where-Object { $_.Name -like "*Setup*" } | ForEach-Object {
                  Write-Host "Found: $($_.Name)"
                }
              }
            } else {
              if (-not (Test-Path $innoCompiler)) {
                Write-Warning "âš  Inno Setup compiler not found at: $innoCompiler"
              }
              if (-not (Test-Path $issFile)) {
                Write-Warning "âš  ISS file not found: $issFile"
              }
              Write-Warning "Skipping installer creation"
            }
          }
          
        } elseif (Test-Path "build/dist/${appName}") {
          # PyInstaller æž„å»º
          Write-Host "Creating portable package from PyInstaller build..."
          Compress-Archive -Path "build/dist/${appName}/*" -DestinationPath $portableArchiveName -CompressionLevel Optimal
        } else {
          Write-Error "No build output found to package"
          exit 1
        }
        
        Write-Host "=== æž„å»ºäº§ç‰©æ‘˜è¦ ==="
        Write-Host "ä¾¿æºç‰ˆ: $portableArchiveName"
        if (Test-Path $portableArchiveName) {
          Write-Host "âœ“ ä¾¿æºç‰ˆåˆ›å»ºæˆåŠŸï¼Œå¤§å°: $([math]::Round((Get-Item $portableArchiveName).Length / 1MB, 2)) MB"
        } else {
          Write-Warning "âš  ä¾¿æºç‰ˆåˆ›å»ºå¤±è´¥"
        }
        
        # æ£€æŸ¥æ˜¯å¦åˆ›å»ºäº†å®‰è£…ç¨‹åº
        $installerName = "${appName}-${version}-Setup-Windows-x64.exe"
        if (Test-Path $installerName) {
          Write-Host "âœ“ å®‰è£…ç¨‹åºåˆ›å»ºæˆåŠŸ: $installerName"
          Write-Host "  å®‰è£…ç¨‹åºå¤§å°: $([math]::Round((Get-Item $installerName).Length / 1MB, 2)) MB"
        } elseif ($buildMode -eq "nuitka") {
          Write-Warning "âš  é¢„æœŸåˆ›å»ºå®‰è£…ç¨‹åºä½†æœªæ‰¾åˆ°"
        } else {
          Write-Host "â„¹ PyInstaller æ¨¡å¼ï¼Œè·³è¿‡å®‰è£…ç¨‹åºåˆ›å»º"
        }
        
        Write-Host "=== æ‰€æœ‰ç”Ÿæˆçš„æ–‡ä»¶ ==="
        Get-ChildItem -Filter "*.zip", "*.exe" | Where-Object { $_.Name -like "${appName}*" } | ForEach-Object {
          Write-Host "ðŸ“„ $($_.Name) - $([math]::Round($_.Length / 1MB, 2)) MB"
        }
      shell: powershell

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: ${{ needs.get-config.outputs.app_name }}-${{ needs.get-config.outputs.app_ver }}-${{ runner.os }}
        path: |
          build/**/*
          ${{ needs.get-config.outputs.app_exec }}-*.zip
          ${{ needs.get-config.outputs.app_exec }}-*-Setup-*.exe
        include-hidden-files: true

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.create_release == 'true'
      uses: softprops/action-gh-release@v2
      with:
        files: |
          ${{ needs.get-config.outputs.app_exec }}-*.zip
          ${{ needs.get-config.outputs.app_exec }}-*-Setup-*.exe
        tag_name: ${{ startsWith(github.ref, 'refs/tags/') && github.ref_name || format('v{0}', needs.get-config.outputs.app_ver) }}
        name: ${{ needs.get-config.outputs.app_name }} ${{ needs.get-config.outputs.app_ver }}
        draft: false
        prerelease: ${{ contains(needs.get-config.outputs.app_ver, 'beta') || contains(needs.get-config.outputs.app_ver, 'alpha') }}
        generate_release_notes: true
        body: |
          ## ${{ needs.get-config.outputs.app_name }} ${{ needs.get-config.outputs.app_ver }}
          
          ### æž„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ needs.get-config.outputs.app_ver }}
          - **æž„å»ºå·¥å…·**: ${{ github.event.inputs.build_mode || 'nuitka' }}
          - **å¹³å°**: Windows x64
          - **Python**: ${{ matrix.python-version }}
          
          ### ä¸‹è½½æ–‡ä»¶è¯´æ˜Ž
          
          #### ä¾¿æºç‰ˆ (Portable)
          - ðŸ“¦ `${{ needs.get-config.outputs.app_exec }}-${{ needs.get-config.outputs.app_ver }}-*-Portable-Windows-x64.zip`
          - **ç‰¹ç‚¹**: è§£åŽ‹å³ç”¨ï¼Œæ— éœ€å®‰è£…
          - **é€‚ç”¨**: ä¸´æ—¶ä½¿ç”¨ã€ä¾¿æºå­˜å‚¨ã€ä¸æƒ³åœ¨ç³»ç»Ÿå®‰è£…è½¯ä»¶çš„ç”¨æˆ·
          
          #### å®‰è£…ç‰ˆ (Setup) - ä»… Nuitka æž„å»º
          - ðŸ› ï¸ `${{ needs.get-config.outputs.app_exec }}-${{ needs.get-config.outputs.app_ver }}-Setup-Windows-x64.exe`
          - **ç‰¹ç‚¹**: æ ‡å‡† Windows å®‰è£…ç¨‹åºï¼Œæ”¯æŒå¼€å§‹èœå•ã€æ¡Œé¢å¿«æ·æ–¹å¼
          - **é€‚ç”¨**: é•¿æœŸä½¿ç”¨ã€å¸Œæœ›é›†æˆåˆ°ç³»ç»Ÿçš„ç”¨æˆ·
          
          ### ä½¿ç”¨æ–¹æ³•
          
          **ä¾¿æºç‰ˆ**:
          1. ä¸‹è½½ ZIP æ–‡ä»¶
          2. è§£åŽ‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `${{ needs.get-config.outputs.app_exec }}.exe`
          
          **å®‰è£…ç‰ˆ**:
          1. ä¸‹è½½ EXE å®‰è£…ç¨‹åº
          2. å³é”®"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
          3. æŒ‰å‘å¯¼å®Œæˆå®‰è£…
          4. ä»Žå¼€å§‹èœå•æˆ–æ¡Œé¢å¿«æ·æ–¹å¼å¯åŠ¨
          
          ### æŠ€æœ¯ä¿¡æ¯
          - **æž„å»ºå¼•æ“Ž**: ${{ github.event.inputs.build_mode == 'pyinstaller' && 'PyInstaller' || 'Nuitka' }}
          - **æ‰“åŒ…å·¥å…·**: ${{ github.event.inputs.build_mode == 'pyinstaller' && 'PyInstaller' || 'Nuitka + Inno Setup' }}
          - **æ”¯æŒç³»ç»Ÿ**: Windows 10/11 (x64)
          
          æ›´å¤šä¿¡æ¯è¯·è®¿é—®: ${{ needs.get-config.outputs.app_url }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
